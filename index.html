/*
Personal Sports Portal
Single-file React app (Tailwind + shadcn-friendly structure)

How to use:
1. Create a new GitHub repo and add this file as `src/App.jsx` in a standard Create React App / Vite React project.
2. Install dependencies (example for Vite + React):
   npm create vite@latest my-portal --template react
   cd my-portal
   npm install
   Add Tailwind per Tailwind docs (tailwindcss, postcss, autoprefixer) and configure `tailwind.config.js` to scan `src/**/*`.
   Optionally install shadcn/ui, lucide-react, and recharts if you plan to use them.
3. Replace `mockData` with real API calls (Sports API, News API). Where live fetching is required there's a placeholder and comments.
4. To host on GitHub Pages: either use `gh-pages` npm package or enable Pages in repository settings (build to `docs/` or use `main` branch / `gh-pages` branch). See instructions near bottom of this file.

This single-file app demonstrates the requested features:
- Choose your home team
- Shows sports sorted by popularity
- Clicking a sport shows starting players (offense by default) sorted by popularity
- Toggle to defensive players
- Clicking a player shows photo, height, weight, fantasy points, and a news feed (placeholder)
- Chat forum with per-user posts saved to localStorage and a new daily prompt posted automatically

Notes on extending to real data:
- Player images, heights, weights, fantasy points: replace mock data with a sports-data API (e.g., SportRadar, TheSportsDB, Fantasy API). Many require API keys.
- News: use a news API (NewsAPI.org, Google News via RSS) and filter by player's full name.

*/

import React, { useEffect, useMemo, useState } from "react";

// Mock dataset. Replace with API-driven data in production.
const mockData = {
  user: {
    name: "Alex Fan",
    homeTeam: "Seahawks",
  },
  sports: [
    { id: "football", name: "Football", popularity: 95 },
    { id: "basketball", name: "Basketball", popularity: 92 },
    { id: "baseball", name: "Baseball", popularity: 70 },
    { id: "soccer", name: "Soccer", popularity: 65 },
    { id: "hockey", name: "Hockey", popularity: 40 },
    { id: "cricket", name: "Cricket", popularity: 20 },
  ],
  // Each sport has teams -> players. For simplicity we provide one team per sport set to user's homeTeam.
  rosters: {
    football: {
      offense: [
        { id: "f1", name: "Quarterback Q. Star", pop: 99, height: "6'4\"", weight: "230 lbs", fantasy: 28.4, img: "https://via.placeholder.com/320x320?text=QB" },
        { id: "f2", name: "Running Back R. Rush", pop: 85, height: "5'11\"", weight: "215 lbs", fantasy: 18.2, img: "https://via.placeholder.com/320x320?text=RB" },
        { id: "f3", name: "Wideout W. Catch", pop: 76, height: "6'1\"", weight: "200 lbs", fantasy: 15.9, img: "https://via.placeholder.com/320x320?text=WR" },
      ],
      defense: [
        { id: "fd1", name: "Linebacker L. Tack", pop: 91, height: "6'2\"", weight: "245 lbs", fantasy: 9.4, img: "https://via.placeholder.com/320x320?text=LB" },
        { id: "fd2", name: "Cornerback C. Lock", pop: 80, height: "5'10\"", weight: "190 lbs", fantasy: 7.2, img: "https://via.placeholder.com/320x320?text=CB" },
      ],
    },
    basketball: {
      offense: [
        { id: "b1", name: "Guard G. Handles", pop: 94, height: "6'3\"", weight: "190 lbs", fantasy: 34.6, img: "https://via.placeholder.com/320x320?text=G" },
        { id: "b2", name: "Forward F. Dunk", pop: 82, height: "6'9\"", weight: "230 lbs", fantasy: 28.1, img: "https://via.placeholder.com/320x320?text=F" },
      ],
      defense: [
        { id: "bd1", name: "Center C. Block", pop: 90, height: "7'0\"", weight: "260 lbs", fantasy: 22.4, img: "https://via.placeholder.com/320x320?text=C" },
      ],
    },
    // other sports omitted for brevity — you can add similarly
  },
  chatPrompts: [
    "What was your favorite moment from last season?",
    "Which player do you want the team to sign next?",
    "Predict the starting lineup for the next game.",
    "Who is the most underrated player on the team?",
    "What's your score prediction for the next matchup?",
  ],
};

function sortByPopularity(list) {
  return [...list].sort((a, b) => (b.popularity ?? b.pop ?? 0) - (a.popularity ?? a.pop ?? 0));
}

export default function App() {
  const [user, setUser] = useState(mockData.user);
  const [sports, setSports] = useState(mockData.sports);
  const [selectedSport, setSelectedSport] = useState(sports[0]?.id ?? null);
  const [playerSide, setPlayerSide] = useState("offense"); // 'offense' or 'defense'
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [newsCache, setNewsCache] = useState({});

  // chat state persisted in localStorage under key `portal_chat`
  const [chatState, setChatState] = useState(() => {
    try {
      const raw = localStorage.getItem("portal_chat_v1");
      return raw ? JSON.parse(raw) : { posts: [], lastPromptDate: null, prompts: mockData.chatPrompts };
    } catch (e) {
      return { posts: [], lastPromptDate: null, prompts: mockData.chatPrompts };
    }
  });

  // Ensure daily prompt is posted once per day
  useEffect(() => {
    const today = new Date().toISOString().slice(0, 10);
    if (chatState.lastPromptDate !== today) {
      // choose a prompt in a stable way per date
      const idx = Math.abs(hashString(today)) % chatState.prompts.length;
      const prompt = chatState.prompts[idx];
      const newState = {
        ...chatState,
        lastPromptDate: today,
        posts: [{ id: `prompt-${today}`, author: "system", text: `Daily prompt: ${prompt}`, time: Date.now() }, ...chatState.posts],
      };
      setChatState(newState);
      localStorage.setItem("portal_chat_v1", JSON.stringify(newState));
    }
  }, []);

  // persist chat
  useEffect(() => {
    localStorage.setItem("portal_chat_v1", JSON.stringify(chatState));
  }, [chatState]);

  // When sport changes reset selections
  useEffect(() => {
    setSelectedPlayer(null);
    setPlayerSide("offense");
  }, [selectedSport]);

  const sportsSorted = useMemo(() => sortByPopularity(sports), [sports]);

  const roster = useMemo(() => {
    return mockData.rosters[selectedSport] ?? { offense: [], defense: [] };
  }, [selectedSport]);

  function selectPlayer(player) {
    setSelectedPlayer(player);
    // Attempt to load news (placeholder). Replace fetch logic to use a real API key.
    fetchNewsForPlayer(player);
  }

  async function fetchNewsForPlayer(player) {
    if (!player) return;
    const key = player.name;
    if (newsCache[key]) return; // already have
    // Placeholder: in production call a news API here. Example:
    // const resp = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(player.name)}&apiKey=YOUR_KEY`);
    // const data = await resp.json();
    // For demo we simulate articles
    const simulated = [
      { title: `${player.name} posts strong practice`, source: "Local Sports", url: "#" },
      { title: `${player.name} leads team in fantasy this week`, source: "FanSite", url: "#" },
    ];
    setNewsCache((s) => ({ ...s, [key]: simulated }));
  }

  function postChat(author, text) {
    const newPost = { id: `p-${Date.now()}`, author, text, time: Date.now() };
    setChatState((s) => ({ ...s, posts: [newPost, ...s.posts] }));
  }

  return (
    <div className="min-h-screen bg-gray-50 p-6 font-sans">
      <header className="max-w-6xl mx-auto mb-6">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold">{user.name}'s Sports Portal</h1>
          <div className="text-sm text-gray-600">Home team: <strong>{user.homeTeam}</strong></div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        <section className="col-span-1 bg-white p-4 rounded-2xl shadow-sm">
          <h2 className="text-lg font-semibold mb-3">Sports (most popular → least)</h2>
          <ul>
            {sportsSorted.map((s) => (
              <li key={s.id}>
                <button
                  onClick={() => setSelectedSport(s.id)}
                  className={`w-full text-left p-2 rounded hover:bg-gray-100 flex justify-between items-center ${selectedSport === s.id ? "bg-blue-50" : ""}`}
                >
                  <span>{s.name}</span>
                  <span className="text-xs text-gray-500">pop {s.popularity}</span>
                </button>
              </li>
            ))}
          </ul>
        </section>

        <section className="col-span-2 bg-white p-4 rounded-2xl shadow-sm">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold">{(sports.find(x => x.id === selectedSport)?.name ?? "Sport").toUpperCase()}</h2>
            <div className="flex gap-2">
              <button onClick={() => setPlayerSide("offense")} className={`px-3 py-1 rounded ${playerSide === "offense" ? "bg-blue-600 text-white" : "bg-gray-100"}`}>Offense</button>
              <button onClick={() => setPlayerSide("defense")} className={`px-3 py-1 rounded ${playerSide === "defense" ? "bg-blue-600 text-white" : "bg-gray-100"}`}>Defense</button>
            </div>
          </div>

          <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="md:col-span-1">
              <h3 className="font-medium mb-2">Starters ({playerSide})</h3>
              <ul>
                {sortByPopularity((roster[playerSide] ?? [])).map((p) => (
                  <li key={p.id}>
                    <button onClick={() => selectPlayer(p)} className={`w-full text-left p-2 rounded hover:bg-gray-50 flex justify-between items-center ${selectedPlayer?.id === p.id ? "bg-blue-50" : ""}`}>
                      <div>
                        <div className="font-semibold">{p.name}</div>
                        <div className="text-xs text-gray-500">{p.height} • {p.weight}</div>
                      </div>
                      <div className="text-sm text-gray-600">fantasy: {p.fantasy}</div>
                    </button>
                  </li>
                ))}
                {((roster[playerSide] ?? []).length === 0) && <li className="text-sm text-gray-500 p-2">No starters available for this side.</li>}
              </ul>
            </div>

            <div className="md:col-span-2">
              <h3 className="font-medium mb-2">Player details</h3>
              {selectedPlayer ? (
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="flex gap-4">
                    <img src={selectedPlayer.img} alt={selectedPlayer.name} className="w-32 h-32 rounded object-cover" />
                    <div>
                      <h4 className="text-xl font-semibold">{selectedPlayer.name}</h4>
                      <div className="text-sm text-gray-600">{selectedPlayer.height} • {selectedPlayer.weight}</div>
                      <div className="mt-2">Fantasy points this week: <strong>{selectedPlayer.fantasy}</strong></div>
                      <div className="mt-3">
                        <button onClick={() => alert('Switch to player analytics (placeholder)')} className="px-3 py-1 rounded bg-gray-200">View analytics</button>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4">
                    <h5 className="font-medium">Latest news</h5>
                    <ul className="mt-2">
                      {(newsCache[selectedPlayer.name] ?? []).map((a, idx) => (
                        <li key={idx} className="py-2 border-b last:border-b-0">
                          <a href={a.url} target="_blank" rel="noreferrer" className="font-medium">{a.title}</a>
                          <div className="text-xs text-gray-500">{a.source}</div>
                        </li>
                      ))}
                      {((newsCache[selectedPlayer.name] ?? []).length === 0) && <li className="text-sm text-gray-500">No news loaded. Connect a news API to populate articles.</li>}
                    </ul>
                  </div>
                </div>
              ) : (
                <div className="text-sm text-gray-500">Select a player to view details.</div>
              )}
            </div>
          </div>
        </section>

        <section className="col-span-1 md:col-span-3 bg-white p-4 rounded-2xl shadow-sm">
          <h2 className="text-lg font-semibold">Fan Chat Forum</h2>
          <ChatForum state={chatState} onPost={(author, text) => postChat(author, text)} />
        </section>
      </main>

      <footer className="max-w-6xl mx-auto mt-6 text-sm text-gray-500">
        Built with ❤️ — customize data sources & deploy to GitHub Pages. See top of file for instructions.
      </footer>
    </div>
  );
}

function ChatForum({ state, onPost }) {
  const [name, setName] = useState("");
  const [text, setText] = useState("");

  function submit() {
    if (!name.trim() || !text.trim()) return alert("Please provide name and message.");
    onPost(name.trim(), text.trim());
    setText("");
  }

  return (
    <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div className="md:col-span-1">
        <div className="mb-2 text-xs text-gray-500">Post as</div>
        <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Your display name" className="w-full p-2 border rounded" />
        <div className="mt-3 text-xs text-gray-500">Message</div>
        <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="Write your message" className="w-full p-2 border rounded h-24" />
        <div className="mt-2 flex gap-2">
          <button onClick={submit} className="px-3 py-1 rounded bg-blue-600 text-white">Post</button>
          <button onClick={() => { setName(""); setText(""); }} className="px-3 py-1 rounded bg-gray-100">Clear</button>
        </div>
      </div>

      <div className="md:col-span-2">
        <div className="space-y-3 max-h-72 overflow-auto">
          {state.posts.map((p) => (
            <div key={p.id} className={`p-2 rounded ${p.author === 'system' ? 'bg-yellow-50' : 'bg-gray-50'}`}>
              <div className="flex justify-between text-sm">
                <div className="font-semibold">{p.author}</div>
                <div className="text-xs text-gray-500">{new Date(p.time).toLocaleString()}</div>
              </div>
              <div className="mt-1 text-sm">{p.text}</div>
            </div>
          ))}
          {state.posts.length === 0 && <div className="text-sm text-gray-500">No posts yet. Be the first!</div>}
        </div>
      </div>
    </div>
  );
}

// small helper
function hashString(str) {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 16777619);
  return h >>> 0;
}

/*
Deployment notes (GitHub Pages - quick method):
1. If using a Vite + React app, build with `npm run build`.
2. Copy the `dist`/`build` output into a `docs/` folder in the root of the repository and push to `main`.
3. In GitHub repo -> Settings -> Pages -> select `main` branch and `/docs` folder.
4. Or use the `gh-pages` package to publish to `gh-pages` branch automatically.

Security & production
- Switch from localStorage chat to a backend (Firebase / Supabase / your own API) before allowing sensitive data or moderation.
- Use proper CORS-allowed API keys for sports & news data and keep keys secret (server-side proxy).
*/
